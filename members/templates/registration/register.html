{% extends 'base.html' %}

{% block title %}Registo - Cantos de Papel{% endblock %}

{% block extra_css %}
<style>
  .register-container .btn {
    padding: 15px 30px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    border: none !important;
    border-radius: 8px !important;
    cursor: pointer !important;
    transition: all 0.3s !important;
    text-align: center !important;
    text-decoration: none !important;
    display: inline-block !important;
    width: 100% !important;
  }
  
  .register-container .btn:not(.secondary) {
    background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%) !important;
    color: white !important;
  }
  
  .register-container .btn:not(.secondary):hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3) !important;
  }
  
  .register-container .btn.secondary {
    background: #f5f5f5 !important;
    color: #666 !important;
  }
  
  .register-container .btn.secondary:hover {
    background: #e0e0e0 !important;
  }
  
  .register-container .actions {
    display: flex !important;
    flex-direction: column !important;
    gap: 15px !important;
    margin-top: 30px !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="catalog-section">
  <div class="register-container">
    <h1>üìù Crie a sua conta</h1>
    <p style="text-align: center; color: #999; margin-bottom: 20px;">
      Junte-se √† nossa comunidade de leitores
    </p>
    
    <!-- MOSTRAR ERROS DO FORMUL√ÅRIO DJANGO -->
    {% if form.errors %}
    <div style="background: #fee; border: 2px solid #f88; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
      <strong style="color: #c00;">‚ö†Ô∏è Erros no formul√°rio:</strong>
      <ul style="margin: 10px 0 0 0; padding-left: 20px;">
        {% for field in form %}
          {% for error in field.errors %}
            <li style="color: #c00; margin: 5px 0;"><strong>{{ field.label }}:</strong> {{ error }}</li>
          {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li style="color: #c00;">{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    
    <form method="post">
      {% csrf_token %}
      
      <h3>üîê Credenciais de Acesso</h3>
      
      <div class="field-group">
        <label>Nome de utilizador *</label>
        {{ form.username }}
        {% if form.username.help_text %}
          <small style="color: #888; font-size: 12px; display: block; margin-top: 4px;">{{ form.username.help_text }}</small>
        {% endif %}
      </div>
      
      <div class="field-group">
        <label>Email *</label>
        {{ form.email }}
      </div>
      
      <div class="row">
        <div class="col">
          <label>Palavra-passe *</label>
          {{ form.password1 }}
        </div>
        <div class="col">
          <label>Confirmar palavra-passe *</label>
          {{ form.password2 }}
        </div>
      </div>
      
      <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; margin: 20px 0; border-radius: 4px; font-size: 13px; color: #555;">
        <strong>‚ÑπÔ∏è Requisitos da palavra-passe:</strong>
        <ul style="margin: 8px 0 0 0; padding-left: 20px;">
          <li style="margin: 4px 0;">M√≠nimo de 8 caracteres</li>
          <li style="margin: 4px 0;">N√£o pode ser muito comum (ex: "password123")</li>
          <li style="margin: 4px 0;">N√£o pode ser totalmente num√©rica</li>
          <li style="margin: 4px 0;">N√£o pode ser muito semelhante ao nome de utilizador</li>
        </ul>
      </div>
      
      <h3>üë§ Informa√ß√£o Pessoal</h3>
      
      <div class="row">
        <div class="col">
          <label>Primeiro Nome *</label>
          {{ form.primeiro_nome }}
        </div>
        <div class="col">
          <label>√öltimo Nome *</label>
          {{ form.ultimo_nome }}
        </div>
      </div>
      
      <div class="row">
        <div class="col">
          <label>Telem√≥vel (opcional)</label>
          {{ form.telefone }}
        </div>
        <div class="col">
          <label>N√∫mero de Contribuinte - NIF (opcional)</label>
          {{ form.nif }}
        </div>
      </div>

      <h3>üìç Endere√ßo de Entrega (opcional)</h3>
      
      <div class="field-group">
        <label>Pa√≠s</label>
        {{ form.pais }}
      </div>
      
      <div class="field-group">
        <label>Morada Completa</label>
        {{ form.morada }}
      </div>
      
      <div class="row">
        <div class="col">
          <label>Porta</label>
          {{ form.porta }}
        </div>
        <div class="col">
          <label>Andar</label>
          {{ form.andar }}
        </div>
      </div>
      
      <div class="row">
        <div class="col">
          <label>C√≥digo Postal</label>
          {{ form.codigo_postal }}
        </div>
        <div class="col">
          <label>Localidade</label>
          {{ form.localidade }}
        </div>
      </div>

      <div id="form-errors" aria-live="polite"></div>

      <div class="actions" style="margin-top: 30px;">
        <button type="submit" class="btn" style="cursor: pointer;">‚úì Criar Conta</button>
        <a href="/accounts/login/" class="btn secondary" style="display: inline-flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;">
          ‚Üê J√° tem conta? Fa√ßa login
        </a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    function validNIF(nif){
      if(!/^\d{9}$/.test(nif)) return false;
      let total = 0;
      for(let i=0;i<8;i++) total += parseInt(nif[i],10) * (9 - i);
      let check = 11 - (total % 11);
      if(check >= 10) check = 0;
      return check === parseInt(nif[8],10);
    }
    
    function validPhone(t){
      let s = t.replace(/\s+/g,'').replace(/-/g,'');
      if(s.startsWith('+351')) s = s.slice(4);
      return /^\d{9}$/.test(s);
    }
    
    function validCP(cp){
      return /^\d{4}-\d{3}$/.test(cp);
    }

    const nifEl = document.getElementById('id_nif');
    const telEl = document.getElementById('id_telefone');
    const cpEl = document.getElementById('id_codigo_postal');
    const submitBtn = document.querySelector('button[type="submit"]');
    const errDiv = document.getElementById('form-errors');

    function update(){
      const errors = [];
      
      if(nifEl && nifEl.value.trim()){
        if(!validNIF(nifEl.value.trim())){
          errors.push('NIF inv√°lido (deve ter 9 d√≠gitos v√°lidos).');
          nifEl.style.borderColor = '#d32f2f';
        } else {
          nifEl.style.borderColor = '#4caf50';
        }
      }
      
      if(telEl && telEl.value.trim()){
        if(!validPhone(telEl.value.trim())){
          errors.push('Telefone inv√°lido (9 d√≠gitos ou +351XXXXXXXXX).');
          telEl.style.borderColor = '#d32f2f';
        } else {
          telEl.style.borderColor = '#4caf50';
        }
      }
      
      if(cpEl && cpEl.value.trim()){
        if(!validCP(cpEl.value.trim())){
          errors.push('C√≥digo postal inv√°lido (formato: 1234-567).');
          cpEl.style.borderColor = '#d32f2f';
        } else {
          cpEl.style.borderColor = '#4caf50';
        }
      }
      
      if(errors.length > 0){
        errDiv.innerHTML = errors.map(e => '<div style="padding: 8px 0;">‚ö†Ô∏è '+e+'</div>').join('');
        errDiv.classList.add('active');
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.5';
        submitBtn.style.cursor = 'not-allowed';
      } else {
        errDiv.innerHTML = '';
        errDiv.classList.remove('active');
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
      }
    }

    [nifEl, telEl, cpEl].forEach(el => {
      if(!el) return;
      el.addEventListener('input', update);
      el.addEventListener('blur', update);
    });

    // Animaci√≥n de entrada
    const container = document.querySelector('.register-container');
    if (container) {
      container.style.opacity = '0';
      container.style.transform = 'translateY(20px)';
      setTimeout(() => {
        container.style.transition = 'all 0.5s ease';
        container.style.opacity = '1';
        container.style.transform = 'translateY(0)';
      }, 100);
    }
  })();
</script>
{% endblock %}