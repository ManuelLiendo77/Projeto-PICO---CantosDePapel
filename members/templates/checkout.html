{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - Cantos de Papel{% endblock %}

{% block content %}
<div class="checkout-container">
    <div class="checkout-header">
        <h1>üõí Finalizar Pedido</h1>
        <p style="color:#5d6d7e;margin-bottom:15px;">Confirme os dados de envio e pagamento. Entregamos em 1-2 dias √∫teis para Portugal continental.</p>
        <div class="checkout-steps">
            <div class="step active">1. Carrinho</div>
            <div class="step active">2. Dados de envio</div>
            <div class="step">3. Confirma√ß√£o</div>
        </div>
    </div>

    <form method="post" id="checkout-form" class="checkout-form" onsubmit="return false;">
        {% csrf_token %}
        <input type="hidden" name="carrinho_data" id="carrinho_data">
        
        <div class="checkout-content">
            <!-- Coluna esquerda: Formul√°rio -->
            <div class="checkout-left">
                <div class="form-section">
                    <h2>üìã Dados pessoais</h2>
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-error">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    
                    <div class="form-group">
                        <label for="id_nome_completo">{{ form.nome_completo.label }}</label>
                        {{ form.nome_completo }}
                        {% if form.nome_completo.errors %}
                            <span class="error">{{ form.nome_completo.errors.0 }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_email">{{ form.email.label }}</label>
                            {{ form.email }}
                            {% if form.email.errors %}
                                <span class="error">{{ form.email.errors.0 }}</span>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="id_telefone">{{ form.telefone.label }}</label>
                            {{ form.telefone }}
                            {% if form.telefone.errors %}
                                <span class="error">{{ form.telefone.errors.0 }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>üìç Morada de envio</h2>
                    
                    <div class="form-group">
                        <label for="id_morada">{{ form.morada.label }}</label>
                        {{ form.morada }}
                        {% if form.morada.errors %}
                            <span class="error">{{ form.morada.errors.0 }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_cidade">{{ form.cidade.label }}</label>
                            {{ form.cidade }}
                            {% if form.cidade.errors %}
                                <span class="error">{{ form.cidade.errors.0 }}</span>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="id_codigo_postal">{{ form.codigo_postal.label }}</label>
                            {{ form.codigo_postal }}
                            {% if form.codigo_postal.errors %}
                                <span class="error">{{ form.codigo_postal.errors.0 }}</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_pais">{{ form.pais.label }}</label>
                        {{ form.pais }}
                    </div>
                    
                    <div class="form-group">
                        <label for="id_notas">{{ form.notas.label }}</label>
                        {{ form.notas }}
                    </div>
                </div>

                <div class="form-section">
                    <label class="checkbox-label">
                        {{ form.aceitar_termos }}
                        <span>{{ form.aceitar_termos.label }} <a href="{% url 'terminos_condiciones' %}" target="_blank" onclick="event.stopPropagation();">Ver termos</a></span>
                    </label>
                    {% if form.aceitar_termos.errors %}
                        <span class="error">{{ form.aceitar_termos.errors.0 }}</span>
                    {% endif %}
                </div>
            </div>

            <!-- Coluna direita: Resumo do pedido -->
            <div class="checkout-right">
                <div class="order-summary">
                    <h2>üì¶ Resumo do pedido</h2>
                    
                    <div class="summary-items" id="summary-items">
                        <!-- Preenchido dinamicamente via JavaScript -->
                    </div>
                    
                    <!-- Cup√£o de Desconto -->
                    <div class="cupom-section">
                        <h3>üéüÔ∏è Cup√£o de desconto</h3>
                        <div class="cupom-input-group">
                            <input type="text" id="cupom-codigo" placeholder="Introduza o c√≥digo do cup√£o" maxlength="20">
                            <button type="button" id="btn-aplicar-cupom">Aplicar</button>
                        </div>
                        <input type="hidden" name="cupom_codigo" id="cupom_codigo_hidden">
                        <div id="cupom-mensagem" class="cupom-mensagem"></div>
                        <div id="cupom-aplicado" class="cupom-aplicado" style="display: none;">
                            <div class="cupom-info">
                                <span class="cupom-codigo-display"></span>
                                <button type="button" id="btn-remover-cupom" class="btn-remover">‚úï</button>
                            </div>
                            <div class="cupom-descricao"></div>
                        </div>
                    </div>
                    
                    <div class="summary-totals">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="summary-subtotal">0.00‚Ç¨</span>
                        </div>
                        <div class="summary-row">
                            <span>IVA (23%):</span>
                            <span id="summary-iva">0.00‚Ç¨</span>
                        </div>
                        <div class="summary-row" id="desconto-row" style="display: none;">
                            <span class="desconto-label">Desconto:</span>
                            <span class="desconto-valor" id="summary-desconto">-0.00‚Ç¨</span>
                        </div>
                        <div class="summary-row">
                            <span>Envio:</span>
                            <span>Inclu√≠do</span>
                        </div>
                        <div class="summary-row total">
                            <strong>Total:</strong>
                            <strong id="summary-total">0.00‚Ç¨</strong>
                        </div>
                    </div>
                    
                    <!-- Bot√£o Comprar Agora -->
                    <button type="button" class="btn-comprar-agora" id="btn-comprar">
                        üõí Comprar agora
                    </button>
                    
                    <!-- Container para o bot√£o PayPal (oculto at√© valida√ß√£o) -->
                    <div id="paypal-button-container" style="display: none; margin-top: 15px;"></div>
                    
                    <!-- Mensagem de processamento -->
                    <div id="payment-processing" style="display: none; text-align: center; padding: 20px; background: #e8f5e9; border-radius: 8px; margin-top: 15px;">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px; color: #2e7d32; font-weight: 600;">A processar pagamento...</p>
                    </div>
                    
                    <!-- Mensagens de erro -->
                    <div id="payment-error" style="display: none; margin-top: 15px;" class="alert alert-error"></div>
                    
                    <div class="payment-notice">
                        <p style="font-size: 13px; color: #666; margin: 15px 0; text-align: center;">
                            üîí Pagamento seguro via PayPal | Envio gr√°tis
                        </p>
                    </div>
                    
                    <a href="{% url 'carrinho' %}" class="btn-volver">‚Üê Rever carrinho</a>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.checkout-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 30px 20px;
}

.checkout-header {
    text-align: center;
    margin-bottom: 40px;
}

.checkout-header h1 {
    font-size: 36px;
    color: #333;
    margin-bottom: 20px;
}

.checkout-steps {
    display: flex;
    justify-content: center;
    gap: 20px;
}

.step {
    padding: 10px 20px;
    background: #f0f0f0;
    border-radius: 20px;
    color: #999;
    font-weight: 600;
}

.step.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.checkout-form {
    display: block;
}

.checkout-content {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
}

.checkout-left {
    display: flex;
    flex-direction: column;
    gap: 25px;
}

.form-section {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

.form-section h2 {
    font-size: 22px;
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: 600;
    color: #555;
    margin-bottom: 8px;
}

.form-input,
.form-textarea {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s ease;
}

.form-input:focus,
.form-textarea:focus {
    outline: none;
    border-color: #667eea;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.payment-methods {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.payment-method {
    display: flex;
    align-items: center;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.payment-method:hover {
    border-color: #667eea;
    background: #f8f9ff;
}

.payment-method input[type="radio"] {
    margin-right: 12px;
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.payment-label {
    font-size: 16px;
    font-weight: 600;
    color: #333;
}

.payment-info-box {
    background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
    padding: 20px;
    border-radius: 8px;
    border: 2px solid #667eea;
    margin-top: 15px;
}

.payment-notice {
    background: #fff8e1;
    padding: 12px;
    border-radius: 6px;
    border-left: 4px solid #ffc107;
    margin-top: 15px;
}

#paypal-button-container {
    min-height: 50px;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

#payment-processing {
    background: #e8f5e9;
    padding: 20px;
    border-radius: 8px;
    border: 2px solid #4caf50;
}

#payment-error {
    margin-top: 15px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    padding: 10px;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.checkbox-label:hover {
    background: #f5f5f5;
}

.checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #667eea;
}

.error {
    color: #f44336;
    font-size: 14px;
    margin-top: 5px;
    display: block;
    font-weight: 600;
}

.alert {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.alert-error {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #ef9a9a;
}

.checkout-right {
    position: sticky;
    top: 20px;
    height: fit-content;
}

.order-summary {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

.order-summary h2 {
    font-size: 22px;
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
}

.summary-items {
    margin-bottom: 20px;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
}

.summary-item:last-child {
    border-bottom: none;
}

.item-details {
    flex: 1;
}

.item-name {
    font-weight: 600;
    color: #333;
    font-size: 14px;
}

.item-quantity {
    font-size: 13px;
    color: #666;
}

.item-price {
    font-weight: 600;
    color: #667eea;
}

.summary-totals {
    border-top: 2px solid #f0f0f0;
    padding-top: 15px;
    margin-top: 15px;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    color: #666;
}

.summary-row.total {
    font-size: 20px;
    color: #333;
    padding-top: 15px;
    margin-top: 10px;
    border-top: 2px solid #667eea;
}

/* Estilos do Cup√£o */
.cupom-section {
    margin: 20px 0;
    padding: 20px;
    background: #faf8f5;
    border-radius: 8px;
    border: 2px solid #e8d5c4;
}

.cupom-section h3 {
    font-size: 16px;
    color: #5a3e2b;
    margin-bottom: 15px;
    font-weight: 600;
}

.cupom-input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.cupom-input-group input {
    flex: 1;
    padding: 10px 15px;
    border: 2px solid #e8d5c4;
    border-radius: 6px;
    font-size: 14px;
    text-transform: uppercase;
    transition: all 0.3s ease;
}

.cupom-input-group input:focus {
    outline: none;
    border-color: #c87941;
}

.cupom-input-group button {
    padding: 10px 20px;
    background: #c87941;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.cupom-input-group button:hover {
    background: #b06835;
}

.cupom-mensagem {
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 13px;
    margin-top: 8px;
    display: none;
}

.cupom-mensagem.erro {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #ef9a9a;
    display: block;
}

.cupom-mensagem.sucesso {
    background: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #81c784;
    display: block;
}

.cupom-aplicado {
    background: #e8f5e9;
    border: 2px solid #81c784;
    border-radius: 6px;
    padding: 12px;
    margin-top: 10px;
}

.cupom-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.cupom-codigo-display {
    font-weight: 700;
    color: #2e7d32;
    font-size: 14px;
    font-family: 'Courier New', monospace;
}

.btn-remover {
    background: transparent;
    border: none;
    color: #c62828;
    font-size: 18px;
    cursor: pointer;
    padding: 0 5px;
    transition: all 0.2s ease;
}

.btn-remover:hover {
    color: #d32f2f;
    transform: scale(1.1);
}

.cupom-descricao {
    font-size: 12px;
    color: #1b5e20;
}

.desconto-label {
    color: #2e7d32 !important;
    font-weight: 600;
}

.desconto-valor {
    color: #2e7d32 !important;
    font-weight: 600;
}

/* Bot√≥n Comprar Agora - Estilo Amazon */
.btn-comprar-agora {
    width: 100%;
    padding: 16px 24px;
    background: linear-gradient(180deg, #f7b84b 0%, #f0a500 100%);
    color: #111;
    border: 1px solid #d69e31;
    border-radius: 8px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 20px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
}

.btn-comprar-agora:hover {
    background: linear-gradient(180deg, #f0a500 0%, #e89800 100%);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transform: translateY(-1px);
}

.btn-comprar-agora:active {
    transform: translateY(0);
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}

.btn-comprar-agora:disabled {
    background: #ccc;
    color: #666;
    cursor: not-allowed;
    border-color: #999;
}

.btn-volver {
    display: block;
    text-align: center;
    margin-top: 15px;
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
}

.btn-volver:hover {
    text-decoration: underline;
}

@media (max-width: 1024px) {
    .checkout-content {
        grid-template-columns: 1fr;
    }
    
    .checkout-right {
        position: static;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Carregar o carrinho e mostrar resumo
document.addEventListener('DOMContentLoaded', function() {
    const carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
    
    if (carrinho.length === 0) {
        alert('O carrinho est√° vazio');
        window.location.href = '/carrinho/';
        return;
    }
    
    // Prevenir submit del formulario
    const checkoutForm = document.getElementById('checkout-form');
    checkoutForm.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        return false;
    });
    
    // Guardar dados do carrinho no campo oculto
    document.getElementById('carrinho_data').value = JSON.stringify(carrinho);
    
    // Mostrar itens do carrinho
    const summaryItems = document.getElementById('summary-items');
    let subtotal = 0;
    
    carrinho.forEach(item => {
        const itemTotal = parseFloat(item.preco) * item.quantidade;
        subtotal += itemTotal;
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'summary-item';
        itemDiv.innerHTML = `
            <div class="item-details">
                <div class="item-name">${item.titulo}</div>
                <div class="item-quantity">x${item.quantidade}</div>
            </div>
            <div class="item-price">${itemTotal.toFixed(2)}‚Ç¨</div>
        `;
        summaryItems.appendChild(itemDiv);
    });
    
    // Vari√°veis globais para c√°lculo
    window.subtotal = subtotal;
    window.descontoCupom = 0;
    
    // Fun√ß√£o para atualizar totais
    function atualizarTotais() {
        const iva = window.subtotal * 0.23;
        const total = window.subtotal + iva - window.descontoCupom;
        
        document.getElementById('summary-subtotal').textContent = window.subtotal.toFixed(2) + '‚Ç¨';
        document.getElementById('summary-iva').textContent = iva.toFixed(2) + '‚Ç¨';
        document.getElementById('summary-total').textContent = total.toFixed(2) + '‚Ç¨';
        
        // Mostrar/ocultar linha de desconto
        const descontoRow = document.getElementById('desconto-row');
        if (window.descontoCupom > 0) {
            descontoRow.style.display = 'flex';
            document.getElementById('summary-desconto').textContent = '-' + window.descontoCupom.toFixed(2) + '‚Ç¨';
        } else {
            descontoRow.style.display = 'none';
        }
    }
    
    // Atualizar totais iniciais
    atualizarTotais();
    
    // ===== GUARDAR Y RECUPERAR DATOS DEL FORMULARIO =====
    const form = document.getElementById('checkout-form');
    const camposFormulario = [
        'id_nome_completo',
        'id_email', 
        'id_telefone',
        'id_morada',
        'id_cidade',
        'id_codigo_postal',
        'id_pais',
        'id_notas',
        'id_aceitar_termos'
    ];
    
    // Recuperar datos guardados al cargar la p√°gina
    camposFormulario.forEach(campoId => {
        const campo = document.getElementById(campoId);
        if (!campo) return;
        
        const valorGuardado = localStorage.getItem('checkout_' + campoId);
        if (valorGuardado) {
            if (campo.type === 'checkbox') {
                campo.checked = valorGuardado === 'true';
            } else {
                campo.value = valorGuardado;
            }
        }
    });
    
    // Guardar datos mientras el usuario escribe
    camposFormulario.forEach(campoId => {
        const campo = document.getElementById(campoId);
        if (!campo) return;
        
        campo.addEventListener('input', function() {
            if (this.type === 'checkbox') {
                localStorage.setItem('checkout_' + campoId, this.checked);
            } else {
                localStorage.setItem('checkout_' + campoId, this.value);
            }
        });
        
        // Para checkbox tambi√©n escuchar el evento change
        if (campo.type === 'checkbox') {
            campo.addEventListener('change', function() {
                localStorage.setItem('checkout_' + campoId, this.checked);
            });
        }
    });
    
    // Aplicar cupom
    document.getElementById('btn-aplicar-cupom').addEventListener('click', function() {
        const codigoCupom = document.getElementById('cupom-codigo').value.trim().toUpperCase();
        const mensagemDiv = document.getElementById('cupom-mensagem');
        
        if (!codigoCupom) {
            mensagemDiv.className = 'cupom-mensagem erro';
            mensagemDiv.textContent = 'Por favor, insira um c√≥digo de cupom';
            return;
        }
        
        // Fazer requisi√ß√£o AJAX
        const formData = new FormData();
        formData.append('codigo', codigoCupom);
        formData.append('valor_pedido', window.subtotal);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch('/validar-cupom/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.valido) {
                // Cupom v√°lido
                window.descontoCupom = data.desconto;
                
                // Atualizar UI
                document.getElementById('cupom-codigo').value = '';
                document.getElementById('cupom_codigo_hidden').value = data.codigo;
                document.querySelector('.cupom-input-group').style.display = 'none';
                mensagemDiv.style.display = 'none';
                
                const cupomAplicado = document.getElementById('cupom-aplicado');
                cupomAplicado.style.display = 'block';
                cupomAplicado.querySelector('.cupom-codigo-display').textContent = data.codigo;
                cupomAplicado.querySelector('.cupom-descricao').textContent = data.descricao;
                
                // Atualizar totais
                atualizarTotais();
                
                // Mensagem de sucesso
                mensagemDiv.className = 'cupom-mensagem sucesso';
                mensagemDiv.textContent = 'Cupom aplicado com sucesso!';
                mensagemDiv.style.display = 'block';
                setTimeout(() => {
                    mensagemDiv.style.display = 'none';
                }, 3000);
                
            } else {
                // Cupom inv√°lido
                mensagemDiv.className = 'cupom-mensagem erro';
                mensagemDiv.textContent = data.erro;
            }
        })
        .catch(error => {
            mensagemDiv.className = 'cupom-mensagem erro';
            mensagemDiv.textContent = 'Erro ao validar cupom. Tente novamente.';
        });
    });
    
    // Remover cupom
    document.getElementById('btn-remover-cupom').addEventListener('click', function() {
        window.descontoCupom = 0;
        document.getElementById('cupom_codigo_hidden').value = '';
        document.querySelector('.cupom-input-group').style.display = 'flex';
        document.getElementById('cupom-aplicado').style.display = 'none';
        document.getElementById('cupom-mensagem').style.display = 'none';
        atualizarTotais();
    });
    
    // Aplicar cupom ao pressionar Enter
    document.getElementById('cupom-codigo').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('btn-aplicar-cupom').click();
        }
    });
    
    // Listener para el checkbox de t√©rminos
    const aceitarTermosCheckbox = document.querySelector('#id_aceitar_termos');
    if (aceitarTermosCheckbox) {
        aceitarTermosCheckbox.addEventListener('change', function() {
            const checkboxLabel = this.closest('.checkbox-label');
            if (checkboxLabel) {
                if (this.checked) {
                    checkboxLabel.style.outline = 'none';
                } else {
                    checkboxLabel.style.outline = '2px solid #f44336';
                    checkboxLabel.style.borderRadius = '4px';
                }
            }
        });
    }
    
    // Listeners para remover bordes rojos al escribir en campos
    const formCheckout = document.getElementById('checkout-form');
    if (formCheckout) {
        const campos = formCheckout.querySelectorAll('.form-input, .form-textarea');
        campos.forEach(campo => {
            campo.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.style.borderColor = '#e0e0e0';
                }
            });
        });
    }
    
    // ===== VALIDACI√ìN DEL FORMULARIO =====
    function validarFormulario() {
        const form = document.getElementById('checkout-form');
        const campos = {
            nome_completo: form.querySelector('#id_nome_completo'),
            email: form.querySelector('#id_email'),
            telefone: form.querySelector('#id_telefone'),
            morada: form.querySelector('#id_morada'),
            cidade: form.querySelector('#id_cidade'),
            codigo_postal: form.querySelector('#id_codigo_postal'),
        };
        
        const erros = [];
        let primerError = null;
        
        // Validar campos de texto
        for (const [nombre, campo] of Object.entries(campos)) {
            if (!campo || !campo.value.trim()) {
                erros.push(`Campo obrigat√≥rio: ${nombre.replace(/_/g, ' ')}`);
                campo.style.borderColor = '#f44336';
                if (!primerError) primerError = campo;
            } else {
                campo.style.borderColor = '#e0e0e0';
            }
        }
        
        // Validar email
        if (campos.email && campos.email.value) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(campos.email.value)) {
                erros.push('Email inv√°lido');
                campos.email.style.borderColor = '#f44336';
                if (!primerError) primerError = campos.email;
            }
        }
        
        // Validar checkbox de t√©rminos
        const aceitarTermos = form.querySelector('#id_aceitar_termos');
        const checkboxLabel = aceitarTermos ? aceitarTermos.closest('.checkbox-label') : null;
        
        if (aceitarTermos && !aceitarTermos.checked) {
            erros.push('Deve aceitar os termos e condi√ß√µes para continuar');
            if (checkboxLabel) {
                checkboxLabel.style.outline = '2px solid #f44336';
                checkboxLabel.style.borderRadius = '4px';
                checkboxLabel.style.padding = '10px';
            }
            if (!primerError) primerError = aceitarTermos;
        } else if (checkboxLabel) {
            checkboxLabel.style.outline = 'none';
        }
        
        // Mostrar errores si los hay
        const errorDiv = document.getElementById('payment-error');
        if (erros.length > 0) {
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = '<strong style="font-size: 16px;">‚ö†Ô∏è Por favor, corrija os seguintes erros:</strong><br><br>' + 
                                 erros.map(e => '‚Ä¢ ' + e).join('<br>');
            
            if (primerError) {
                primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return false;
        }
        
        errorDiv.style.display = 'none';
        return true;
    }
    
    // ===== BOT√ìN COMPRAR AGORA =====
    const btnComprar = document.getElementById('btn-comprar');
    let paypalCargado = false;
    
    btnComprar.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Validar formulario
        if (!validarFormulario()) {
            return;
        }
        
        // Si ya se carg√≥ PayPal, simplemente mostrarlo
        if (paypalCargado) {
            document.getElementById('paypal-button-container').style.display = 'block';
            document.getElementById('paypal-button-container').scrollIntoView({ behavior: 'smooth', block: 'center' });
            btnComprar.textContent = '‚¨áÔ∏è Pague con PayPal abaixo';
            btnComprar.style.background = 'linear-gradient(180deg, #667eea 0%, #764ba2 100%)';
            btnComprar.style.color = 'white';
            return;
        }
        
        // Cambiar texto del bot√≥n
        btnComprar.disabled = true;
        btnComprar.textContent = '‚è≥ A carregar PayPal...';
        
        // Cargar PayPal SDK y renderizar
        cargarPayPal();
    });
    
    // ===== CARGAR Y CONFIGURAR PAYPAL =====
    function cargarPayPal() {
        // Verificar si ya existe el script
        if (document.querySelector('script[src*="paypal.com/sdk"]')) {
            renderizarPayPal();
            return;
        }
        
        // Cargar SDK de PayPal
        const script = document.createElement('script');
        // IMPORTANTE: Substituir este Client ID pelo seu pr√≥prio de https://developer.paypal.com/
        // Este √© um Client ID de SANDBOX (modo teste) - N√£o faz cobran√ßas reais
        // Para obt√™-lo: https://developer.paypal.com/ > Apps & Credentials > Sandbox
        const PAYPAL_CLIENT_ID = 'AXYduD2wUSU1Db5TPbsDWe0dA_rE7vG0F8VOcVKgb4OpHkoIui_RbJG6iURYwvippgD4mmEiJ-dGoJc8';
        script.src = `https://www.paypal.com/sdk/js?client-id=${PAYPAL_CLIENT_ID}&currency=EUR&locale=pt_PT`;
        script.onload = renderizarPayPal;
        script.onerror = function() {
            btnComprar.disabled = false;
            btnComprar.textContent = 'üõí Comprar agora';
            const errorDiv = document.getElementById('payment-error');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = '<strong>Erro ao carregar PayPal</strong><br>Por favor, verifique sua conex√£o e tente novamente.';
        };
        document.head.appendChild(script);
    }
    
    function renderizarPayPal() {
        const container = document.getElementById('paypal-button-container');
        container.innerHTML = ''; // Limpiar contenedor
        
        paypal.Buttons({
            style: {
                layout: 'vertical',
                color: 'gold',
                shape: 'rect',
                label: 'paypal',
                height: 50
            },
            
            createOrder: function(data, actions) {
        // [CORRE√á√ÉO] Recalcular totais garantindo formato correto
        const totais = calcularTotais();
        const carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
        
        const items = carrinho.map(item => {
            // [TRUQUE] Converter "19,99" para "19.99" antes de fazer parseFloat
            // Garante que o PayPal recebe os c√™ntimos!
            let precoStr = String(item.preco).replace(',', '.');
            let precoFloat = parseFloat(precoStr);

            return {
                name: item.titulo,
                unit_amount: {
                    currency_code: 'EUR',
                    value: precoFloat.toFixed(2)
                },
                quantity: item.quantidade.toString()
            };
        });
                
                return actions.order.create({
            purchase_units: [{
                description: 'Livros - Cantos de Papel',
                amount: {
                    currency_code: 'EUR',
                    value: totais.total, // Usa o total calculado pela fun√ß√£o JS
                    breakdown: {
                        item_total: { currency_code: 'EUR', value: totais.subtotal },
                        tax_total: { currency_code: 'EUR', value: totais.iva },
                        discount: { currency_code: 'EUR', value: totais.desconto }
                    }
                },
                items: items
            }]
            // ... context mantido ...
        });
    },
            
            onApprove: function(data, actions) {
        // Mostra o spinner
        document.getElementById('payment-processing').style.display = 'block';
        document.getElementById('paypal-button-container').style.display = 'none';
        btnComprar.style.display = 'none';
        
        return actions.order.capture().then(function(orderData) {
            const form = document.getElementById('checkout-form');
            const formData = new FormData(form);
            
            // Adicionar dados do PayPal
            formData.append('paypal_order_id', orderData.id);
            formData.append('paypal_payer_id', orderData.payer.payer_id);
            formData.append('paypal_amount', orderData.purchase_units[0].amount.value);
            
            // [CORRE√á√ÉO] Usar 'set' em vez de 'append' para evitar dados duplicados
            formData.set('carrinho_data', localStorage.getItem('carrinho'));

            // [IMPORTANTE] Usar URL din√¢mica do Django
            fetch("{% url 'processar_pagamento_paypal' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    // Garante que o CSRF token vai no header tamb√©m (seguran√ßa extra)
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Limpar carrinho e redirecionar
                    localStorage.removeItem('carrinho');
                    window.location.href = `/pedido-confirmado/${data.pedido_id}/`;
                } else {
                    throw new Error(data.mensagem || 'Erro desconhecido');
                }
            })
            .catch(error => {
                // Tratamento de erros
                console.error("Erro no fetch:", error);
                const errorDiv = document.getElementById('payment-error');
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Erro: ' + error.message;
                
                // Resetar UI
                document.getElementById('payment-processing').style.display = 'none';
                document.getElementById('paypal-button-container').style.display = 'block';
            });
        });
    },
            
            onCancel: function() {
                document.getElementById('payment-error').style.display = 'block';
                document.getElementById('payment-error').textContent = 'Pagamento cancelado. Pode tentar novamente quando desejar.';
                document.getElementById('payment-error').style.background = '#fff3cd';
                document.getElementById('payment-error').style.color = '#856404';
            },
            
            onError: function(err) {
                console.error('Erro PayPal:', err);
                document.getElementById('payment-error').style.display = 'block';
                document.getElementById('payment-error').textContent = 'Erro ao processar pagamento. Tente novamente.';
            }
            
        }).render('#paypal-button-container');
        
        // Marcar como cargado y mostrar
        paypalCargado = true;
        container.style.display = 'block';
        btnComprar.disabled = false;
        btnComprar.textContent = '‚¨áÔ∏è Pague com PayPal abaixo';
        btnComprar.style.background = 'linear-gradient(180deg, #667eea 0%, #764ba2 100%)';
        btnComprar.style.color = 'white';
        
        // Scroll hasta PayPal
        container.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    function calcularTotais() {
        const subtotal = window.subtotal || 0;
        const iva = subtotal * 0.23;
        const desconto = window.descontoCupom || 0;
        const total = subtotal + iva - desconto;
        
        return {
            subtotal: subtotal.toFixed(2),
            iva: iva.toFixed(2),
            desconto: desconto.toFixed(2),
            total: total.toFixed(2)
        };
    }
});
</script>
{% endblock %}
